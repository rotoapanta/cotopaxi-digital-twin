<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Cesium Test - OSM/Esri sin Ion</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css">
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; background:#000; }
    #status { position:fixed; top:10px; left:10px; background:rgba(20,20,20,.9); color:#fff; padding:8px 10px; z-index:9999; font-family:system-ui,sans-serif; font-size:14px; border-radius:4px; }
  </style>
</head>
<body>
  <div id="status">Inicializando…</div>
  <div id="cesiumContainer"></div>

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>
  <script>
  (function(){
    const statusEl = document.getElementById('status');
    const setStatus = (m)=> statusEl.textContent = m;

    try {
      // 1) Viewer sin Ion (terreno elipsoidal plano)
      const viewer = new Cesium.Viewer('cesiumContainer', {
        terrainProvider: new Cesium.EllipsoidTerrainProvider(),
        baseLayerPicker: false,
        geocoder: false,
        animation: false,
        timeline: false
      });

      // 2) Capa base OSM usando el provider dedicado (estable)
      const osm = new Cesium.OpenStreetMapImageryProvider({
        url: 'https://a.tile.openstreetmap.org/' // Cesium maneja subdominios
      });
      viewer.imageryLayers.addImageryProvider(osm);

      // 3) Fallback: si OSM falla, agregar Esri World Imagery por plantilla de tiles
      viewer.scene.globe.tileLoadProgressEvent.addEventListener(function(remaining) {
        if (remaining === 0) setStatus('OK: OSM cargado');
      });

      // si en 3 s no cargó nada, intento Esri
      setTimeout(() => {
        try {
          const stats = viewer.scene.globe._surface._tileLoadQueueHigh?.length ?? 0;
          if (viewer.imageryLayers.length === 0 || stats > 1000) {
            setStatus('OSM falló; intentando Esri World Imagery…');
            const esri = new Cesium.UrlTemplateImageryProvider({
              url: 'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
            });
            viewer.imageryLayers.addImageryProvider(esri);
          }
        } catch (e) {
          setStatus('Fallback Esri error: ' + (e?.message || e));
          console.error(e);
        }
      }, 3000);

      // 4) Cámara + marca
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(-78.436, -0.680, 12000),
        orientation: { heading: 0, pitch: Cesium.Math.toRadians(-60), roll: 0 }
      });

      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(-78.436, -0.680, 5897),
        point: { pixelSize: 10, color: Cesium.Color.YELLOW },
        label: { text: 'Cotopaxi (test)', showBackground: true }
      });

      // Info WebGL
      setTimeout(() => {
        const ok = viewer.scene?.context ? 'WebGL ok' : 'WebGL no disponible';
        setStatus(statusEl.textContent + ' | ' + ok);
      }, 800);

    } catch (e) {
      setStatus('Error creando Viewer: ' + (e?.message || e));
      console.error(e);
    }
  })();
  </script>
</body>
</html>
